<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <!-- Only include the official Telegram WebApp script -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 24px;
            color: var(--tg-theme-text-color, #222222);
        }
        
        .user-info {
            margin-bottom: 20px;
        }
        
        .user-name {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--tg-theme-button-color, #2481cc);
        }
        
        .avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 16px;
            background-color: var(--tg-theme-button-color, #2481cc);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
        }
        
        .welcome-text {
            margin-top: 16px;
            line-height: 1.5;
        }
        
        .not-telegram {
            color: #f44336;
            margin-top: 20px;
        }
        
        /* Error container styles */
        #errorContainer {
            background-color: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 8px;
            color: #f44336;
            font-size: 14px;
            margin-top: 20px;
            padding: 12px;
            text-align: left;
            width: 90%;
            max-width: 400px;
            word-break: break-word;
            display: none;
        }
        
        .error-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        /* Debug panel styles */
        #debugPanel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome to Mini App</h1>
        
        <div class="user-info">
            <div id="avatar" class="avatar"></div>
            <div id="userName" class="user-name">Loading...</div>
        </div>
        
        <p class="welcome-text">This simple Telegram Mini App displays your Telegram name.</p>
    </div>
    
    <p id="notTelegram" class="not-telegram" style="display: none;">
        This app only works within the Telegram application.
    </p>
    
    <!-- Error container -->
    <div id="errorContainer">
        <div class="error-title">Error:</div>
        <div id="errorMessage"></div>
    </div>
    
    <!-- Debug panel toggle -->
    <div id="debugPanel">DEBUG</div>

    <script>
        // Global error handler function
        function showError(error, details = '') {
            console.error('Error:', error);
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            let errorText = error;
            if (error instanceof Error) {
                errorText = error.message;
                if (error.stack) {
                    details += '\n\nStack: ' + error.stack;
                }
            }
            
            errorMessage.textContent = errorText + (details ? '\n\nDetails: ' + details : '');
            errorContainer.style.display = 'block';
        }
        
        // Catch all global errors
        window.onerror = function(message, source, lineno, colno, error) {
            showError(error || message, `Location: ${source}:${lineno}:${colno}`);
            return true; // Prevents the default error handling
        };
        
        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            showError('Unhandled Promise Rejection', event.reason);
        });
        
        // Debug panel functionality
        document.getElementById('debugPanel').addEventListener('click', function() {
            // Force a non-fatal error for testing
            try {
                const webAppInfo = window.Telegram && window.Telegram.WebApp ? 
                    JSON.stringify(window.Telegram.WebApp.initDataUnsafe, null, 2) : 
                    'WebApp not available';
                
                showError('Debug Info (Not an error)', webAppInfo);
            } catch (e) {
                showError(e);
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check if Telegram WebApp is available
                if (window.Telegram && window.Telegram.WebApp) {
                    // Initialize Telegram WebApp
                    const webApp = window.Telegram.WebApp;
                    
                    // Log init data for debugging
                    console.log('WebApp initData available:', !!webApp.initData);
                    
                    // Expand to maximum allowed height
                    webApp.expand();
                    
                    try {
                        // Get user data
                        const user = webApp.initDataUnsafe.user;
                        
                        if (user) {
                            // Display user name
                            const userNameElement = document.getElementById('userName');
                            const avatarElement = document.getElementById('avatar');
                            
                            // Set user name
                            const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                            userNameElement.textContent = fullName;
                            
                            // Set avatar initials
                            avatarElement.textContent = user.first_name.charAt(0);
                            
                            // Trigger closing animation when ready
                            webApp.ready();
                        } else {
                            // If user data is not available
                            document.getElementById('userName').textContent = 'Hello, Telegram User!';
                            document.getElementById('avatar').textContent = '?';
                            showError('User data not available', 'The initDataUnsafe.user object is empty');
                        }
                    } catch (dataError) {
                        showError(dataError, 'Error accessing user data');
                        document.getElementById('userName').textContent = 'Error loading data';
                        document.getElementById('avatar').textContent = '!';
                    }
                } else {
                    // Not running in Telegram
                    document.getElementById('notTelegram').style.display = 'block';
                    document.getElementById('userName').textContent = 'Not in Telegram';
                    document.getElementById('avatar').textContent = '!';
                    
                    if (!window.Telegram) {
                        showError('Telegram object not found', 'Make sure the Telegram Web App JS is loaded correctly');
                    } else if (!window.Telegram.WebApp) {
                        showError('WebApp object not found', 'The Telegram object exists but WebApp is not available');
                    }
                }
            } catch (error) {
                showError(error, 'Error initializing Telegram Mini App');
                document.getElementById('userName').textContent = 'Error loading data';
                document.getElementById('avatar').textContent = '!';
            }
        });
    </script>
</body>
</html>
